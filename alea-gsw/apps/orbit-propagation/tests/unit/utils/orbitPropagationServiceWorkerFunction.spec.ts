import type { components } from "@aleasat/gmat-api";
import { expect } from "chai";
import {
  db,
  dbKeys,
  dbStateElement,
  loadOrbitPropagation,
  state,
} from "../../../src/repositories/orbitPropagationStore.js";
import {
  workerFindFullPasses,
  workerFindPasses,
  workerGetGroundTrack,
} from "../../../src/utils/orbitPropagationServiceWorkerFunction.js";

describe("utils/orbitPropagationServiceWorkerFunction.ts", () => {
  before(async function () {
    this.timeout(10000);
    const mockGmatData: components["schemas"]["GmatOrbitPropagation"] =
      await fetch("https://artifact.aleasat.space/mockGmatData.json").then(
        async (res) => await res.json(),
      );
    loadOrbitPropagation(mockGmatData);
  });

  after(async () => {
    dbKeys.length = 0;
    Object.keys(db).forEach((key) => delete db[key]);
    //@ts-expect-error
    Object.keys(dbStateElement).forEach((key) => delete dbStateElement[key]);
    state.ready = false;
  });

  it("workerGetGroundTrack function", () => {
    const groundTrack = workerGetGroundTrack(
      db["2024-02-29"],
      new Date("2024-02-29T12:17:22.089Z").getTime(),
      {},
    );

    expect(groundTrack).deep.equal([
      [34.28834495386176, -50.143314780176794, 430.4832573820786],
      [31.67126674339957, -46.99522382957282, 429.843478053107],
      [28.96753887896813, -44.03501127809819, 429.211624938137],
      [26.189948271029014, -41.239157452539374, 428.6006919299725],
      [23.34972727774697, -38.58558944834903, 428.0233180393034],
      [20.45679075810024, -36.05377788432671, 427.4915425249974],
      [17.519955258153427, -33.624694922607546, 427.0165188227393],
      [14.547136432361496, -31.28068874332307, 426.6082609983323],
      [11.545524548371288, -29.005310924688114, 426.2754456604225],
      [8.521739793263741, -26.783118485907004, 426.0252693589782],
      [5.481970483459942, -24.59946690452672, 425.86333795474184],
      [2.4320975086183467, -22.440298167567178, 425.7935725214029],
      [-0.6221911363116196, -20.29193025496564, 425.818120522903],
      [-3.6752922640329744, -18.140847882511416, 425.9372966128749],
      [-6.721582157321181, -15.973494341991811, 426.1495612584804],
      [-9.75531045006729, -13.776063176658427, 426.45153520532676],
      [-12.770489700634236, -11.534288587783964, 426.8380789773619],
      [-15.7607772503952, -9.233234572238427, 427.30240566973043],
      [-18.719345640795126, -6.857084612004115, 427.8362061519365],
      [-21.63873810231424, -4.388937003787788, 428.42978593727],
      [-24.510705551727366, -1.8106149404177314, 429.07221507136364],
      [-27.326022634822234, 0.8974892022809011, 429.75154435594686],
      [-30.074281834757695, 3.7565110766685588, 430.45506140170073],
      [-32.74366682206558, 6.78910725888559, 431.169556538287],
      [-35.32071087942124, 10.01928106754289, 431.8815475352385],
      [-37.79005331482601, 13.47195108040883, 432.5774954153567],
      [-40.13421854249849, 17.172144906779785, 433.24403225989954],
      [-42.33345885023153, 21.143677989911023, 433.86822774826123],
      [-44.36572241079973, 25.407176324721682, 434.43783625997094],
      [-46.20683043412702, 29.97734888689199, 434.94150161115795],
      [-47.83096488240837, 34.859548254914145, 435.3689369737067],
      [-49.21156618372822, 40.045909632307485, 435.71111717057556],
      [-50.32270021648708, 45.511714060082994, 435.96051502213504],
      [-51.14085845676523, 51.21299529668166, 436.1112894338521],
      [-51.647009012224615, 57.0865658235546, 436.15937623773334],
      [-51.828561002385605, 63.05333886041507, 436.1024899115546],
      [-51.68081752955232, 69.02495650891352, 435.9401117470552],
      [-51.2075490895908, 74.9125678584475, 435.67353028907655],
      [-50.42053026917454, 80.63572643674595, 435.3059035034148],
      [-49.3381669789057, 86.12932506426282, 434.842251807886],
      [-47.983566702527504, 91.34729068490587, 434.2893562431227],
      [-46.38247888888636, 96.26293069646779, 433.6556025817945],
      [-44.561457032252356, 100.8667414394211, 432.95083935730963],
      [-42.546441553257075, 105.16285251139945, 432.1862441280964],
      [-40.361812650469744, 109.16515132881878, 431.3741421763434],
      [-38.029862150642735, 112.8937800865554, 430.52774625092115],
      [-35.57058753583159, 116.37232588709048, 429.66086985687525],
      [-33.001706051061696, 119.62576560110382, 428.7876664290279],
      [-30.338801941213042, 122.6790812268219, 427.92240308419787],
      [-27.595542705475374, 125.55640628944087, 427.0792499773015],
      [-24.78392151719829, 128.28056088785254, 426.272019952753],
      [-21.91449994426106, 130.87285470118152, 425.51391385027546],
      [-18.996636766057335, 133.35306567067727, 424.8172851568597],
      [-16.038696132676723, 135.739527894126, 424.1934479314159],
      [-13.048233380518525, 138.04928460153243, 423.65248941862774],
      [-10.032159746699818, 140.29827420453933, 423.2030797748348],
      [-6.996888636286558, 142.5015345892267, 422.8523146446096],
      [-3.948466759775745, 144.67341307898613, 422.6056039296709],
      [-0.8926933582774996, 146.82777776303095, 422.46660882581546],
      [2.1647689963294456, 148.9782280519945, 422.4371922975397],
      [5.218288185466627, 151.13830385326153, 422.5173414833707],
      [8.26215710518713, 153.3216942757058, 422.70511844902103],
      [11.290485409232392, 155.5424468833268, 422.99666461417564],
      [14.29708506091689, 157.8151784721566, 423.38628251372756],
      [17.27534631973132, 160.15528630786372, 423.8665741696723],
      [20.218100603201695, 162.57915760159057, 424.42860688119345],
      [23.11746678054277, 165.10436737004352, 425.06208965446876],
      [25.96467756891193, 167.74985474297137, 425.75556460145435],
      [28.749884069733717, 170.5360529809995, 426.49660411264813],
      [31.461938194950076, 173.48493870396538, 427.2720210507932],
      [34.0881563529413, 176.6199465691061, 428.06809128758505],
      [36.61407405338501, 179.96567241704977, 428.870818484982],
      [39.02321003739882, -176.45273951441857, 429.66620335764037],
      [41.29687257708716, -172.61065672947865, 430.4404940761524],
      [43.41405900721304, -168.48561177749167, 431.1804196595367],
      [45.35152236738006, -164.05967437629877, 431.87341761922016],
      [47.084100097754174, -159.32257841098297, 432.50788027709586],
      [48.58540922884908, -154.27545010250796, 433.0734056903175],
      [49.82899197897726, -148.9346640622099, 433.56100055886145],
      [50.78992787502934, -143.33497601802833, 433.96321329610237],
      [51.44680350720565, -137.53078396572266, 434.27422483174996],
      [51.783772145157634, -131.59442433433165, 434.48991669821226],
      [51.79230431342968, -125.61101815420741, 434.6079336841758],
      [51.472211983689974, -119.6704712198841, 434.6277049749897],
      [50.83167301500692, -113.85833184461343, 434.5504411322645],
      [49.88624894286095, -108.24769084798474, 434.3791337258517],
      [48.6571590614202, -102.89386821715829, 434.11854932890765],
      [47.169224718868186, -97.83254780754817, 433.7751826117801],
      [45.44888694956366, -93.08091848132202, 433.3570985537681],
      [43.52257336579327, -88.64074664451313, 432.8737044063864],
    ]);
  });

  const findPassesResult = [
    {
      x: 2594.529921,
      y: -5600.63299,
      z: 2860.005828,
      t: 1709167495535,
      alt: 12.119533436447062,
      az: 234.68521730707025,
      lat: 24.99860701222197,
      lng: 125.28826864571526,
      height: 428.47333281890224,
    },
    {
      x: -5595.504856,
      y: 2467.056771,
      z: 2973.044719,
      t: 1709215942535,
      alt: 16.18694303689753,
      az: 126.46520127224973,
      lat: 26.069772260816727,
      lng: 144.22417652708523,
      height: 425.6016939948013,
    },
    {
      x: -5398.034689,
      y: 1154.389741,
      z: 3969.619525,
      t: 1709221741535,
      alt: 34.27384532530589,
      az: 320.4118438322584,
      lat: 35.89183575997994,
      lng: 131.71710324786804,
      height: 428.3856793917703,
    },
    {
      x: -4677.628488,
      y: -651.8490403,
      z: 4890.998179,
      t: 1709227605535,
      alt: 5.8109010861366315,
      az: 337.65279897497896,
      lat: 46.18220763457484,
      lng: 127.22130244210436,
      height: 431.99639547501374,
    },
    {
      x: -3216.014522,
      y: -2732.851227,
      z: 5331.080174,
      t: 1709233526535,
      alt: 0.8923252467071799,
      az: 358.6711883734462,
      lat: 51.8084046825871,
      lng: 134.90624682834357,
      height: 434.41768305802543,
    },
    {
      x: -1274.484608,
      y: -4453.937728,
      z: 4978.405954,
      t: 1709239452535,
      alt: 4.706905748440403,
      az: 20.145824371360362,
      lat: 47.23967772010725,
      lng: 143.82195445924563,
      height: 433.8184986332817,
    },
    {
      x: 510.4064376,
      y: -5411.013632,
      z: 4089.509428,
      t: 1709245324535,
      alt: 26.704878068829295,
      az: 38.09304367130641,
      lat: 37.13239433792653,
      lng: 140.6452724124572,
      height: 431.3564994169474,
    },
    {
      x: 1853.177256,
      y: -5770.491197,
      z: 3089.474319,
      t: 1709251130535,
      alt: 21.915803140961863,
      az: 232.05720528146992,
      lat: 27.15636545780519,
      lng: 128.803035224128,
      height: 429.0602804042928,
    },
  ];

  it("workerFindPasses function", () => {
    const result = workerFindPasses(
      db["2024-02-29"],
      32.10104706282733,
      135.6282718107825,
      0,
      {},
    );

    expect(result).to.deep.equal(findPassesResult);
  });

  it("workerFindFullPasses function", function () {
    this.timeout(4000);

    const result = workerFindFullPasses(
      db,
      findPassesResult,
      32.10104706282733,
      135.6282718107825,
      0,
      {},
    );

    expect(result).to.deep.equal([
      {
        x: 2594.529921,
        y: -5600.63299,
        z: 2860.005828,
        t: 1709167495535,
        alt: 12.119533436447062,
        az: 234.68521730707025,
        lat: 24.99860701222197,
        lng: 125.28826864571526,
        height: 428.47333281890224,
        rise: {
          t: 1709167222535,
          x: 931.6018708,
          y: -5355.659157,
          z: 4088.02531,
        },
        set: {
          t: 1709167767535,
          x: 4009.919213,
          y: -5323.147114,
          z: 1369.242024,
        },
      },
      {
        x: -5595.504856,
        y: 2467.056771,
        z: 2973.044719,
        t: 1709215942535,
        alt: 16.18694303689753,
        az: 126.46520127224973,
        lat: 26.069772260816727,
        lng: 144.22417652708523,
        height: 425.6016939948013,
        rise: {
          t: 1709215653535,
          x: -5327.521187,
          y: 3987.374392,
          z: 1400.16063,
        },
        set: {
          t: 1709216232535,
          x: -5274.028985,
          y: 681.3524934,
          z: 4236.638444,
        },
      },
      {
        x: -5398.034689,
        y: 1154.389741,
        z: 3969.619525,
        t: 1709221741535,
        alt: 34.27384532530589,
        az: 320.4118438322584,
        lat: 35.89183575997994,
        lng: 131.71710324786804,
        height: 428.3856793917703,
        rise: {
          t: 1709221421535,
          x: -5552.337488,
          y: 3060.44564,
          z: 2458.013498,
        },
        set: {
          t: 1709222063535,
          x: -4543.698089,
          y: -912.6253489,
          z: 4974.727132,
        },
      },
      {
        x: -4677.628488,
        y: -651.8490403,
        z: 4890.998179,
        t: 1709227605535,
        alt: 5.8109010861366315,
        az: 337.65279897497896,
        lat: 46.18220763457484,
        lng: 127.22130244210436,
        height: 431.99639547501374,
        rise: {
          t: 1709227382535,
          x: -5281.075647,
          y: 787.4037209,
          z: 4209.387955,
        },
        set: {
          t: 1709227828535,
          x: -3781.369077,
          y: -2050.316428,
          z: 5265.575029,
        },
      },
      {
        x: -3216.014522,
        y: -2732.851227,
        z: 5331.080174,
        t: 1709233526535,
        alt: 0.8923252467071799,
        az: 358.6711883734462,
        lat: 51.8084046825871,
        lng: 134.90624682834357,
        height: 434.41768305802543,
        rise: {
          t: 1709233427535,
          x: -3699.276147,
          y: -2151.548623,
          z: 5283.501093,
        },
        set: {
          t: 1709233626535,
          x: -2687.478024,
          y: -3285.659533,
          z: 5311.952993,
        },
      },
      {
        x: -1274.484608,
        y: -4453.937728,
        z: 4978.405954,
        t: 1709239452535,
        alt: 4.706905748440403,
        az: 20.145824371360362,
        lat: 47.23967772010725,
        lng: 143.82195445924563,
        height: 433.8184986332817,
        rise: {
          t: 1709239245535,
          x: -2483.858665,
          y: -3483.165971,
          z: 5285.300311,
        },
        set: {
          t: 1709239658535,
          x: -2.607343143,
          y: -5181.600642,
          z: 4405.622263,
        },
      },
      {
        x: 510.4064376,
        y: -5411.013632,
        z: 4089.509428,
        t: 1709245324535,
        alt: 26.704878068829295,
        az: 38.09304367130641,
        lat: 37.13239433792653,
        lng: 140.6452724124572,
        height: 431.3564994169474,
        rise: {
          t: 1709245007535,
          x: -1441.829083,
          y: -4346.009225,
          z: 5027.718751,
        },
        set: {
          t: 1709245639535,
          x: 2387.189162,
          y: -5795.134341,
          z: 2645.815101,
        },
      },
      {
        x: 1853.177256,
        y: -5770.491197,
        z: 3089.474319,
        t: 1709251130535,
        alt: 21.915803140961863,
        az: 232.05720528146992,
        lat: 27.15636545780519,
        lng: 128.803035224128,
        height: 429.0602804042928,
        rise: {
          t: 1709250824535,
          x: -6.524099406,
          y: -5206.315319,
          z: 4376.385583,
        },
        set: {
          t: 1709251434535,
          x: 3485.738716,
          y: -5660.260759,
          z: 1450.467719,
        },
      },
    ]);
  });
});
